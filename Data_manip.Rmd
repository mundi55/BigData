---
title: "Data_manip"
author: "Mundi"
date: "2025-01-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Required packaged
```{r}
library(ggplot2)     # For data visualization
library(dplyr)       # For data manipulation (e.g., mutate, rename)
library(tidyr)       # For data tidying (e.g., handling missing values)
library(skimr)       # For quick data summaries
```

## Loading data and skimming

```{r}
load("C:/Users/Milan/Downloads/allgreI.RData")
load("C:/Users/Milan/Downloads/allgreD.RData")
load("C:/Users/Milan/Downloads/allgreM.RData")

skim(allgreI)
skim(allgreD)
skim(allgreM)
```

# Lets look at the structure of the data
```{r}
str(allgreI)
str(allgreD)
str(allgreM)
```
# Lets add our new variable, immobil to the dataset
```{r}
# Create a new variable 'immobil': 1 if `nbd` = 0 (immobile), otherwise 0
allgreI <- allgreI %>%
  mutate(immobil = ifelse(nbd == 0, 1, 0))

# Check if the variable was created correctly
table(allgreI$immobil)
```

# We will not be using all of these variables so lets only keep the ones we are interested in

```{r}
# Filter the dataset to include only the specified columns
allgreI_filtered <- allgreI %>% select(id_pers, immobil, cspgroup, sexe, dispovp, age)

# Verify the new filtered dataset
skim(allgreI_filtered)
```

# We see we have some missing values for dispovp which need to be handled. Since dispovp is never 0 we assume the NA values are to be set as 0 to indicate no available cars in the household.

```{r}
# Replace NA values in dispovp with 0
allgreI_filtered$dispovp[is.na(allgreI$dispovp)] <- 0

# Confirm that there are no NA values in VP_DISPO
sum(is.na(allgreI_filtered$dispovp))
```


# We want change the structure of age to group it instead of using it as a linear integer variable
```{r}
# Create age groups and remove the 'age' variable
allgreI_filtered <- allgreI_filtered %>%
  mutate(
    age_group = cut(
      age, 
      breaks = c(0, 16, 20, 60, 75, 85, Inf),  # Breakpoints for age groups
      labels = c("0-16", "16-20", "20-60", "60-75", "75-85", "85+"),
      right = FALSE  # Exclude the upper limit
    )
  ) %>%
  select(-age)  # Remove the 'age' column

# Verify that 'age' has been removed
str(allgreI_filtered)

```
```{r}
# Transformations and variable creations
allgreI_filtered <- allgreI_filtered %>%
  mutate(
    # Convert Y to a binary factor with meaningful labels
    immobil = factor(immobil, levels = c(0, 1), labels = c("No", "Yes")),
    
    # Convert cspgroup from integer to factor
    cspgroup = factor(cspgroup),
    
    # Add a binary variable indicating whether there is at least one car
    has_car = ifelse(dispovp > 0, 1, 0),
    
    # Convert has_car to a factor for binary interpretation
    has_car = factor(has_car, levels = c(0, 1), labels = c("No", "Yes")),
    
    # Convert sexe to a factor with labels Male and Female
    sexe = factor(sexe, levels = c(1, 2), labels = c("Male", "Female"))
  )

# Verify the changes
str(allgreI_filtered)
```

# Now we save the manipulated data into a new RData file to work with in the modeling
```{r}
# Save the transformed dataset to an RData file
save(allgreI_filtered, file = "allgreI_filtered.RData")
```

# Now we create a W variable
# We start by joining the datasets together
```{r}
# Datasets samenvoegen op basis van 'id_pers'
merged_data <- allgreM %>%
  inner_join(allgreI, by = "id_pers") %>%
  inner_join(allgreD, by = "id_pers")

# Controleer de eerste paar rijen van de samengevoegde dataset
head(merged_data)
```
# Now we look at the missing values of the relevant variables to create our W variable
```{r}
# Analyze missing values in the relevant variables
missing_summary <- merged_data %>%
  select(NB_velo, dispovp, ABO_TC, abonpeage, LIEU_STAT) %>%
  summarise_all(~sum(is.na(.)))

# Print the summary of missing values
print(missing_summary)

# Visualize the distribution of each variable
merged_data_long <- merged_data %>%
  select(NB_velo, dispovp, ABO_TC, abonpeage, LIEU_STAT) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value")

# Plot the distribution per variable
ggplot(merged_data_long, aes(x = as.factor(Value))) +
  geom_bar() +
  facet_wrap(~Variable, scales = "free") +
  labs(title = "Distribution of Variables",
       x = "Value",
       y = "Frequency") +
  theme_minimal()

# Alternative visualization of missing values with 'naniar' (optional)
# library(naniar)
# vis_miss(merged_data %>% select(NB_velo, VP_DISPO, dispovp, ABO_TC, abonpeage, LIEU_STAT))

# New chunk: Convert NA to 0 for 'abonpeage', 'dispovp', and 'LIEU_STAT'
merged_data <- merged_data %>%
  mutate(
    abonpeage = replace_na(abonpeage, 0),
    dispovp = replace_na(dispovp, 0),
    LIEU_STAT = replace_na(LIEU_STAT, 0)
  )

# Check if the conversion was successful
missing_summary_updated <- merged_data %>%
  select(abonpeage, dispovp, LIEU_STAT) %>%
  summarise_all(~sum(is.na(.)))

print(missing_summary_updated)

```
# Now we create the W variable
```{r}
# New chunk: Create variable 'W'
merged_data <- merged_data %>%
  mutate(W = ifelse(NB_velo == 0 & dispovp == 0 & ABO_TC == 3 & abonpeage == 0 & LIEU_STAT == 0, 0, 1))

# Check the distribution of 'W' with detailed output
cat("Distribution of W:\n")
print(table(merged_data$W))

# Plot the distribution of 'W'
ggplot(merged_data, aes(x = as.factor(W))) +
  geom_bar(fill = "steelblue") +
  labs(title = "Distribution of W",
       x = "W Value",
       y = "Frequency") +
  theme_minimal()

```
```{r}
# Merge 'W' into allgreI_filtered using 'id_pers'
allgreI_filtered <- allgreI_filtered %>%
  left_join(merged_data %>% select(id_pers, W), by = "id_pers")

# Verify that 'W' was correctly added
str(allgreI_filtered)

# Save the updated dataset with 'W' included
save(allgreI_filtered, file = "allgreI_with_W.RData")

# Optional: View the first few rows to check
head(allgreI_filtered)

```
# Check if W is joint well
```{r}
# Check for any rows where dispovp > 0 but W is not 1
invalid_cases <- allgreI_filtered %>%
  filter(dispovp > 0 & W != 1)

# Display the number of violations
cat("Number of cases where dispovp > 0 and W is not 1:", nrow(invalid_cases), "\n")

# If any invalid cases exist, display them
if(nrow(invalid_cases) > 0) {
  print(invalid_cases)
} else {
  cat("Validation passed: W is always 1 when dispovp > 0.\n")
}

```

